<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light only">
    <meta name="darkreader-lock">
    <title>Forgot Password - PPMS</title>
    <!-- Local Bootstrap CSS -->
    <link rel="stylesheet" href="../css/bootstrap/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="../css/fontawesome/all.min.css">
    <!-- PPMS Consolidated Styles -->
    <link rel="stylesheet" href="../css/ppms-styles/shared/variables.css">
    <link rel="stylesheet" href="../css/ppms-styles/shared/safe-typography-enhancements.css">
    <link rel="stylesheet" href="../css/ppms-styles/shared/components.css">
    <link rel="stylesheet" href="../css/ppms-styles/auth/login.css">
    <!-- Mobile Responsive Styles -->
    <link rel="stylesheet" href="../css/ppms-styles/shared/mobile-responsive.css">
    <!-- Favicon -->
    <link rel="icon" href="../assets/Icon Web.ico" type="image/x-icon">
</head>
<body class="receiver-auth-body">
    <div class="receiver-auth-container">
        <!-- Left Panel (Info) -->
        <div class="receiver-left-panel">
            <h2>Reset Your Password</h2>
            <p>Verify your identity to recover your account.</p>
            <img src="../assets/forgotpassword.gif" alt="Forgot Password" class="auth-gif">
        </div>

        <!-- Right Panel (Form) -->
        <div class="receiver-right-panel">
            <!-- Step Indicator -->
            <div class="step-indicator mb-4">
                <div class="step active" id="step-indicator-1"><span>1</span> Verify</div>
                <div class="step" id="step-indicator-2"><span>2</span> Security</div>
                <div class="step" id="step-indicator-3"><span>3</span> Reset</div>
            </div>

            <!-- Step 1: Matric + Phone Verification -->
            <div id="step1" class="step-content">
                <h2>Forgot Password</h2>
                <p class="receiver-welcome-text">Enter your Matric Number and Phone Number</p>

                <form id="step1Form">
                    <div class="receiver-form-group">
                        <label for="matric_number" class="receiver-form-label">Matric Number</label>
                        <div class="position-relative">
                            <i class="fas fa-id-card receiver-input-icon"></i>
                            <input type="text" class="receiver-form-control" id="matric_number"
                                placeholder="e.g., CI230010" required>
                        </div>
                    </div>

                    <div class="receiver-form-group">
                        <label for="phone_number" class="receiver-form-label">Phone Number</label>
                        <div class="position-relative">
                            <i class="fas fa-phone receiver-input-icon"></i>
                            <input type="tel" class="receiver-form-control" id="phone_number"
                                placeholder="e.g., +60123456789 or 0123456789" required>
                        </div>
                    </div>

                    <button type="submit" class="receiver-btn-primary">
                        <i class="fas fa-arrow-right me-2"></i>Next Step
                    </button>
                </form>
            </div>

            <!-- Step 2: Security Question -->
            <div id="step2" class="step-content" style="display: none;">
                <h2>Security Question</h2>
                <p class="receiver-welcome-text">Answer your security question</p>

                <form id="step2Form">
                    <div class="receiver-form-group">
                        <label class="receiver-form-label">Your Security Question:</label>
                        <p id="security_question_display" class="security-question-text"></p>
                    </div>

                    <div class="receiver-form-group">
                        <label for="security_answer" class="receiver-form-label">Your Answer</label>
                        <div class="position-relative">
                            <i class="fas fa-key receiver-input-icon"></i>
                            <input type="text" class="receiver-form-control" id="security_answer"
                                placeholder="Enter your answer" required>
                        </div>
                        <small style="color: #a0aec0;">Answer is case-insensitive</small>
                    </div>

                    <button type="submit" class="receiver-btn-primary">
                        <i class="fas fa-check me-2"></i>Verify Answer
                    </button>
                    <button type="button" class="receiver-btn-secondary mt-2" onclick="goToStep(1)">
                        <i class="fas fa-arrow-left me-2"></i>Back
                    </button>
                </form>
            </div>

            <!-- Step 3: Reset Password -->
            <div id="step3" class="step-content" style="display: none;">
                <h2>Reset Password</h2>
                <p class="receiver-welcome-text">Create your new password</p>

                <form id="step3Form">
                    <div class="receiver-form-group">
                        <label for="new_password" class="receiver-form-label">New Password</label>
                        <div class="position-relative">
                            <i class="fas fa-lock receiver-input-icon"></i>
                            <input type="password" class="receiver-form-control" id="new_password"
                                placeholder="Enter new password" minlength="8" required>
                        </div>
                    </div>

                    <div class="receiver-form-group">
                        <label for="confirm_password" class="receiver-form-label">Confirm Password</label>
                        <div class="position-relative">
                            <i class="fas fa-lock receiver-input-icon"></i>
                            <input type="password" class="receiver-form-control" id="confirm_password"
                                placeholder="Confirm new password" required>
                        </div>
                    </div>

                    <button type="submit" class="receiver-btn-primary">
                        <i class="fas fa-save me-2"></i>Reset Password
                    </button>
                </form>
            </div>

            <!-- Additional Links -->
            <div class="receiver-auth-links mt-4">
                <p>Remember your password? <a href="receiver-login.html">Login here</a></p>
            </div>

            <button onclick="window.location.href='landingpage.html'" class="receiver-btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Landing Page
            </button>
        </div>
    </div>

    <script src="../js/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
    let userData = {};

    // Auto-uppercase matric number
    document.getElementById('matric_number').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });

    function goToStep(step) {
        document.querySelectorAll('.step-content').forEach(el => el.style.display = 'none');
        document.getElementById('step' + step).style.display = 'block';
        document.querySelectorAll('.step-indicator .step').forEach((el, i) => {
            el.classList.toggle('active', i < step);
            el.classList.toggle('completed', i < step - 1);
        });
    }

    // Step 1: Verify Matric + Phone
    document.getElementById('step1Form').addEventListener('submit', function(e) {
        e.preventDefault();
        const matric = document.getElementById('matric_number').value.trim();
        const phone = document.getElementById('phone_number').value.trim();
        const btn = this.querySelector('button[type="submit"]');

        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verifying...';
        btn.disabled = true;

        fetch('../api/forgot-password.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'verify_identity', matric_number: matric, phone_number: phone })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                userData.matric = matric;
                userData.phone = phone;
                document.getElementById('security_question_display').textContent = data.security_question;
                goToStep(2);
            } else {
                Swal.fire({ icon: 'error', title: 'Verification Failed', text: data.message, confirmButtonColor: '#667eea' });
            }
        })
        .catch(() => Swal.fire({ icon: 'error', title: 'Error', text: 'An error occurred. Please try again.', confirmButtonColor: '#667eea' }))
        .finally(() => { btn.innerHTML = '<i class="fas fa-arrow-right me-2"></i>Next Step'; btn.disabled = false; });
    });

    // Step 2: Verify Security Answer
    document.getElementById('step2Form').addEventListener('submit', function(e) {
        e.preventDefault();
        const answer = document.getElementById('security_answer').value.trim();
        const btn = this.querySelector('button[type="submit"]');

        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verifying...';
        btn.disabled = true;

        fetch('../api/forgot-password.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'verify_answer', matric_number: userData.matric, security_answer: answer })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                userData.token = data.token;
                goToStep(3);
            } else {
                Swal.fire({ icon: 'error', title: 'Incorrect Answer', text: data.message, confirmButtonColor: '#667eea' });
            }
        })
        .catch(() => Swal.fire({ icon: 'error', title: 'Error', text: 'An error occurred. Please try again.', confirmButtonColor: '#667eea' }))
        .finally(() => { btn.innerHTML = '<i class="fas fa-check me-2"></i>Verify Answer'; btn.disabled = false; });
    });

    // Step 3: Reset Password
    document.getElementById('step3Form').addEventListener('submit', function(e) {
        e.preventDefault();
        const newPass = document.getElementById('new_password').value;
        const confirmPass = document.getElementById('confirm_password').value;
        const btn = this.querySelector('button[type="submit"]');

        if (newPass !== confirmPass) {
            Swal.fire({ icon: 'error', title: 'Password Mismatch', text: 'Passwords do not match.', confirmButtonColor: '#667eea' });
            return;
        }
        if (newPass.length < 8) {
            Swal.fire({ icon: 'error', title: 'Password Too Short', text: 'Password must be at least 8 characters.', confirmButtonColor: '#667eea' });
            return;
        }

        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Resetting...';
        btn.disabled = true;

        fetch('../api/forgot-password.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'reset_password', matric_number: userData.matric, token: userData.token, new_password: newPass })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                Swal.fire({ icon: 'success', title: 'Password Reset!', text: 'Your password has been reset successfully.', confirmButtonColor: '#43e97b' })
                .then(() => window.location.href = 'receiver-login.html');
            } else {
                Swal.fire({ icon: 'error', title: 'Reset Failed', text: data.message, confirmButtonColor: '#667eea' });
            }
        })
        .catch(() => Swal.fire({ icon: 'error', title: 'Error', text: 'An error occurred. Please try again.', confirmButtonColor: '#667eea' }))
        .finally(() => { btn.innerHTML = '<i class="fas fa-save me-2"></i>Reset Password'; btn.disabled = false; });
    });
    </script>

    <style>
    /* Force light mode */
    :root { color-scheme: light only; }

    /* Step Indicator - Desktop (dark theme) */
    .step-indicator { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .step-indicator .step { display: flex; align-items: center; gap: 0.5rem; color: #6b7280; font-size: 0.85rem; }
    .step-indicator .step span { width: 24px; height: 24px; border-radius: 50%; background: #374151; color: #9ca3af; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.75rem; }
    .step-indicator .step.active { color: #43e97b; }
    .step-indicator .step.active span { background: linear-gradient(135deg, #667eea, #43e97b); color: #fff; }
    .step-indicator .step.completed span { background: #43e97b; color: #fff; }
    .security-question-text { background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; color: #fff; font-weight: 500; border-left: 3px solid #43e97b; }

    /* Mobile Responsive - WHITE CARD THEME */
    @media (max-width: 991.98px) {
        /* Step Indicator - Light theme for mobile */
        .step-indicator .step { color: #6b7280 !important; }
        .step-indicator .step span { background: #e2e8f0 !important; color: #6b7280 !important; }
        .step-indicator .step.active { color: #667eea !important; }
        .step-indicator .step.active span { background: linear-gradient(135deg, #667eea, #43e97b) !important; color: #fff !important; }
        .step-indicator .step.completed span { background: #43e97b !important; color: #fff !important; }

        /* Security question text - Light theme */
        .security-question-text {
            background: #f0f9ff !important;
            color: #1a1a2e !important;
            -webkit-text-fill-color: #1a1a2e !important;
            border-left-color: #667eea !important;
        }
    }

    @media (max-width: 575.98px) {
        .step-indicator { gap: 0.5rem; padding: 0 0.5rem; }
        .step-indicator .step { font-size: 0.75rem; gap: 0.25rem; }
        .step-indicator .step span { width: 20px; height: 20px; font-size: 0.65rem; }
    }
    </style>
</body>
</html>

